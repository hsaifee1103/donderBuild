import{l as J,D as X,d as I,r as S,f,o as p,g as y,j as Q,a as e,t as g,h as W,n as h,A as ee,i as _,v as T,H as j,E as te,R as ae,F as re,k as M,I as $}from"./app-CTtqvBQy.js";const se={key:0,class:"page"},ie={class:"container"},oe={class:"lead"},le={class:"title text-start"},ne={class:"field"},de={class:"with-icon"},ue=["value"],ce=["disabled"],me={key:0,class:"spinner"},fe={key:1,width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",class:"text-gray-500"},pe={key:0,class:"error-text"},ge={class:"field"},ve={key:0,class:"error-text"},ye={class:"field"},he={key:0,class:"error-text"},be={class:"field"},_e={class:"with-icon"},ke={key:0,class:"error-text"},Ne={class:"field"},we={class:"with-icon"},xe={key:0,class:"error-text"},Se={class:"field"},Te={class:"with-icon"},Me=["max"],Oe={key:0,class:"error-text"},Ve={key:0,class:"mb-4 p-3 bg-red-50 text-red-700 rounded-lg"},Ce={class:"flex items-start"},De={class:"text-sm"},Re={class:"form-actions"},ze=["disabled"],Fe={__name:"AddVehicleForm",props:{isVisible:{type:Boolean,default:!1},errorMessage:{type:String,default:null},formData:{type:Object,default:()=>({})}},emits:["close","submit"],setup(O,{emit:L}){var R,z,F,A,q,E,U,B;const u=O,V=L,N=new Date().getFullYear(),t=X({registrationNumber:((R=u.formData)==null?void 0:R.registrationNumber)||"",postcode:((z=u.formData)==null?void 0:z.postcode)||"Not required",engineSize:((F=u.formData)==null?void 0:F.engineSize)||"",transmission:((A=u.formData)==null?void 0:A.transmission)||"",fuelType:((q=u.formData)==null?void 0:q.fuelType)||"",yearOfRegistration:((E=u.formData)==null?void 0:E.yearOfRegistration)||"",carModel:((U=u.formData)==null?void 0:U.carModel)||"",car_id:((B=u.formData)==null?void 0:B.car_id)||null}),w=I(()=>u.formData.car_id),k=S(!1),C=async()=>{var s,a,i,v,o,c,n,m;if(!t.registrationNumber){r.value={registrationNumber:"Please enter a registration number"};return}t.registrationNumber=t.registrationNumber.toUpperCase().replace(/[^A-Z0-9]/g,""),k.value=!0,r.value={};try{const l=await M.post("/lookup-vehicle",{registrationNumber:t.registrationNumber});if(l.data&&l.data.success){const d=l.data.data;t.carModel=d.make||"",t.yearOfRegistration=d.yearOfManufacture||"",t.engineSize=d.engineCapacity?String(d.engineCapacity):"";const x=(d.fuelType||"").toLowerCase();x.includes("petrol")?t.fuelType="petrol":x.includes("diesel")?t.fuelType="diesel":t.fuelType="",$({type:"success",title:"Vehicle Found",message:"Vehicle details have been populated.",confirmButtonText:"OK"})}else l.status===404||((s=l.data)==null?void 0:s.message)==="Vehicle not found."?r.value={registrationNumber:"Vehicle not found. Please check registration."}:((i=(a=l.data)==null?void 0:a.errors)==null?void 0:i.dvla_status)===400||l.status===400?r.value={registrationNumber:"Invalid registration format. Please check and try again."}:r.value={general:"Failed to lookup vehicle. Please enter manually."}}catch(l){if(console.error("DVLA Search Error",l),l.response)if(l.response.status===404)r.value={registrationNumber:"Vehicle not found. Please check registration."};else if(l.response.status===400){const d=(m=(n=(c=(o=(v=l.response.data)==null?void 0:v.errors)==null?void 0:o.dvla_body)==null?void 0:c.errors)==null?void 0:n[0])==null?void 0:m.detail;d&&d.includes("Invalid format")?r.value={registrationNumber:"Invalid registration format. Please check and try again."}:r.value={registrationNumber:"Invalid request. Please check registration details."}}else r.value={general:"Connection error. Please try again."};else r.value={general:"Connection error. Please try again."}}finally{k.value=!1}},Y=s=>{let a=s.target.value.toUpperCase().replace(/[^A-Z0-9]/g,"");t.registrationNumber=a},Z=async()=>{var s,a;if(!(!H()||b.value)){b.value=!0,r.value={};try{const i=K();if(!i)throw new Error("User not authenticated");const v={postcode:t.postcode||"Not Required",car_make:t.carModel,car_model:t.registrationNumber,engine_size:t.engineSize,fuelType:t.fuelType,yearOfManufacture:t.yearOfRegistration,user_id:i,transmission:t.transmission};let o;if(w.value?(v.car_id=t.car_id,o=await M.post("/update-car-details",v)):o=await M.post("/car_details",v),o.data&&o.data.success)V("submit",{...t}),D(),$({type:"success",title:w.value?"Vehicle Updated Successfully":"Vehicle Added Successfully",message:o.data.message||(w.value?"Your vehicle details have been updated.":"Your vehicle has been added to your profile."),confirmButtonText:"Great!"});else if(o.data&&o.data.errors){const c=o.data.errors,n={};c.forEach(m=>{const l=m.match(/The (.+?) field/);if(l){const d=l[1],P={postcode:"postcode",car_make:"carModel",car_model:"registrationNumber",engine_size:"engineSize",fuelType:"fuelType",yearOfManufacture:"yearOfRegistration",transmission:"transmission"}[d];P?n[P]=m:n.general=n.general?`${n.general}; ${m}`:m}else n.general=n.general?`${n.general}; ${m}`:m}),r.value=n}else r.value.general=((s=o.data)==null?void 0:s.message)||"Failed to submit vehicle details. Please try again."}catch(i){if(console.error("Error submitting vehicle form:",i),i.response)if(i.response.status===422){const v=i.response.data.errors||[],o={};v.forEach(c=>{const n=c.match(/The (.+?) field/);if(n){const m=n[1],d={postcode:"postcode",car_make:"carModel",car_model:"registrationNumber",engine_size:"engineSize",fuelType:"fuelType",yearOfManufacture:"yearOfRegistration",transmission:"transmission"}[m];d?o[d]=c:o.general=o.general?`${o.general}; ${c}`:c}else o.general=o.general?`${o.general}; ${c}`:c}),r.value=o}else r.value.general=((a=i.response.data)==null?void 0:a.message)||"Server error occurred";else i.request?r.value.general="Network error. Please check your connection.":r.value.general=i.message||"An unexpected error occurred"}finally{b.value=!1}}},b=S(!1),r=S({}),K=()=>{const s=localStorage.getItem("userData");return s?JSON.parse(s).id:null},G=I(()=>!!t.registrationNumber&&!!t.engineSize&&!!t.transmission&&!!t.fuelType&&!!t.yearOfRegistration&&!!t.carModel),H=()=>{const s={};return t.registrationNumber&&(t.registrationNumber=t.registrationNumber.toUpperCase().replace(/[^A-Z0-9]/g,"")),t.registrationNumber||(s.registrationNumber="Registration number is required"),t.engineSize||(s.engineSize="Engine size is required"),t.transmission?["manual","automatic"].includes(t.transmission)||(s.transmission="Transmission must be manual or automatic"):s.transmission="Transmission is required",t.fuelType?["petrol","diesel"].includes(t.fuelType)||(s.fuelType="Fuel type must be petrol or diesel"):s.fuelType="Fuel type is required",t.yearOfRegistration?(t.yearOfRegistration<1900||t.yearOfRegistration>N)&&(s.yearOfRegistration=`Year must be between 1900 and ${N}`):s.yearOfRegistration="Year of registration is required",t.carModel||(s.carModel="Car model is required"),r.value=s,Object.keys(s).length===0},D=()=>{V("close"),Object.keys(t).forEach(s=>{t[s]=""}),r.value={}};return(s,a)=>(p(),f(re,null,[O.isVisible?(p(),f("div",se,[e("div",ie,[e("section",oe,[e("h1",le,g(u.formData.car_id?"Edit":"Add")+" Your Car Details",1)]),e("form",{class:"form",onSubmit:W(Z,["prevent"])},[e("label",ne,[a[6]||(a[6]=e("span",null,[h("Registration Number "),e("b",{"aria-hidden":"true"},"*")],-1)),e("div",de,[e("input",{id:"registrationNumber",value:t.registrationNumber,onInput:Y,type:"text",placeholder:"e.g. AB12 CDE",required:"",onKeyup:ee(C,["enter"])},null,40,ue),e("button",{type:"button",onClick:C,class:"trailing-btn",disabled:k.value,title:"Search Vehicle Details"},[k.value?(p(),f("div",me)):(p(),f("svg",fe,[...a[5]||(a[5]=[e("path",{d:"M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)])]))],8,ce)]),r.value.registrationNumber?(p(),f("small",pe,g(r.value.registrationNumber),1)):y("",!0)]),e("label",ge,[a[7]||(a[7]=e("span",null,[h("Car Make "),e("b",{"aria-hidden":"true"},"*")],-1)),_(e("input",{id:"carModel","onUpdate:modelValue":a[0]||(a[0]=i=>t.carModel=i),type:"text",placeholder:"e.g. Fiesta, Corolla, X5",required:""},null,512),[[T,t.carModel,void 0,{trim:!0}]]),r.value.carModel?(p(),f("small",ve,g(r.value.carModel),1)):y("",!0)]),e("label",ye,[a[8]||(a[8]=e("span",null,[h("Engine Size "),e("b",{"aria-hidden":"true"},"*")],-1)),_(e("input",{id:"engineSize","onUpdate:modelValue":a[1]||(a[1]=i=>t.engineSize=i),type:"text",placeholder:"e.g. 1.6L",required:""},null,512),[[T,t.engineSize,void 0,{trim:!0}]]),r.value.engineSize?(p(),f("small",he,g(r.value.engineSize),1)):y("",!0)]),e("label",be,[a[11]||(a[11]=e("span",null,[h("Transmission "),e("b",{"aria-hidden":"true"},"*")],-1)),e("div",_e,[_(e("select",{id:"transmission","onUpdate:modelValue":a[2]||(a[2]=i=>t.transmission=i),required:""},[...a[9]||(a[9]=[e("option",{value:""},"Select transmission",-1),e("option",{value:"manual"},"Manual",-1),e("option",{value:"automatic"},"Automatic",-1)])],512),[[j,t.transmission]]),a[10]||(a[10]=e("svg",{class:"trailing",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none","aria-hidden":"true"},[e("path",{d:"M6 9l6 6 6-6",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1))]),r.value.transmission?(p(),f("small",ke,g(r.value.transmission),1)):y("",!0)]),e("label",Ne,[a[14]||(a[14]=e("span",null,[h("Fuel Type "),e("b",{"aria-hidden":"true"},"*")],-1)),e("div",we,[_(e("select",{id:"fuelType","onUpdate:modelValue":a[3]||(a[3]=i=>t.fuelType=i),required:""},[...a[12]||(a[12]=[e("option",{value:""},"Select fuel type",-1),e("option",{value:"petrol"},"Petrol",-1),e("option",{value:"diesel"},"Diesel",-1)])],512),[[j,t.fuelType]]),a[13]||(a[13]=e("svg",{class:"trailing",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none","aria-hidden":"true"},[e("path",{d:"M6 9l6 6 6-6",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1))]),r.value.fuelType?(p(),f("small",xe,g(r.value.fuelType),1)):y("",!0)]),e("label",Se,[a[16]||(a[16]=e("span",null,[h("Year of Registration "),e("b",{"aria-hidden":"true"},"*")],-1)),e("div",Te,[_(e("input",{id:"yearOfRegistration","onUpdate:modelValue":a[4]||(a[4]=i=>t.yearOfRegistration=i),type:"number",min:"1900",max:te(N),placeholder:"e.g. 2020",required:""},null,8,Me),[[T,t.yearOfRegistration]]),a[15]||(a[15]=e("svg",{class:"trailing",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none","aria-hidden":"true"},[e("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",stroke:"currentColor","stroke-width":"2"}),e("path",{d:"M16 2v4M8 2v4M3 10h18",stroke:"currentColor","stroke-width":"2"})],-1))]),r.value.yearOfRegistration?(p(),f("small",Oe,g(r.value.yearOfRegistration),1)):y("",!0)]),r.value.general?(p(),f("div",Ve,[e("div",Ce,[a[18]||(a[18]=e("svg",{class:"h-5 w-5 text-red-500 mr-2 mt-0.5",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z","clip-rule":"evenodd"})],-1)),e("div",null,[a[17]||(a[17]=e("p",{class:"font-medium"},"Error",-1)),e("p",De,g(r.value.general),1)])])])):y("",!0),e("div",Re,[e("button",{type:"button",onClick:D,class:"cancel-btn"}," Cancel "),e("button",{type:"submit",class:"submit-btn",disabled:!G.value||b.value},g(b.value?u.formData.car_id?"Updating Vehicle...":"Adding Vehicle...":u.formData.car_id?"Update Vehicle":"Add Vehicle"),9,ze)])],32)])])):y("",!0),Q(ae)],64))}},qe=J(Fe,[["__scopeId","data-v-270ef19d"]]);export{qe as A};
