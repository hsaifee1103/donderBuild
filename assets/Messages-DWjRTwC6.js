import{l as se,r as v,b as oe,c as ae,o as l,w as re,k as B,e as ne,z as D,u as le,a as e,f as i,g,q as _,t as u,F as $,p as O,n as L,i as ie,A as de,v as ce,h as ue,I as P}from"./app-ra6n0F-f.js";import{P as me}from"./ProviderDashboardLayout-DeGtjkHh.js";import"./NotificationDropdown-cEJAu455.js";import"./x-D73gKmkd.js";const ve={class:"max-w-7xl mx-auto"},ge={class:"bg-white rounded-xl border border-[#E5E7EB] overflow-hidden mt-4"},pe={key:0,class:"text-center py-16"},fe={key:1,class:"flex justify-center items-center py-16"},he={key:2,class:"flex flex-col md:flex-row"},_e={class:"px-4 py-3"},xe={class:"text-base font-semibold"},be={class:"divide-y divide-[#E5E7EB]"},ke=["onClick"],ye={class:"flex items-start gap-3"},we={class:"relative"},Ee=["src","alt"],Ce={class:"min-w-0 flex-1"},Me={class:"flex items-center justify-between gap-2"},Be={class:"truncate font-medium"},Fe={class:"shrink-0 text-xs text-[#6B7280]"},je={class:"mt-1 flex items-center gap-2 text-xs"},Ie={key:0,class:"rounded bg-[#F1F5F9] px-2 py-0.5 font-medium text-[#880E1B]"},Ae={class:"mt-1 flex items-center justify-between gap-2"},De={class:"truncate text-sm text-[#6B7280]"},Le={key:0,class:"shrink-0 inline-flex items-center justify-center rounded-full bg-[#EF4444] px-2 py-0.5 text-xs font-bold text-white","aria-label":"Unread messages"},Se={key:0,class:"md:hidden border-b border-[#E5E7EB] px-4 py-3"},Te={key:1,class:"flex-1 flex items-center justify-center bg-gray-50"},Ve={key:2,class:"flex-1 flex flex-col"},Ue={class:"flex items-center justify-between gap-4 border-b border-[#E5E7EB] px-5 py-3"},Ne={class:"flex items-center gap-3"},ze=["src","alt"],$e={class:"font-semibold"},Oe={class:"text-xs text-[#6B7280]"},Pe={key:0,class:"flex flex-wrap items-start justify-between gap-4 border-b border-[#E5E7EB] px-5 py-3"},He={class:"flex items-start gap-3"},Ke={class:"text-sm font-medium text-[#111827]"},Re={key:0},Ge={key:0},We={key:1},Ze={class:"flex items-center gap-3"},qe={class:"text-right"},Je={class:"text-sm font-semibold"},Ye={class:"text-xs text-[#6B7280]"},Qe={class:"px-5 pt-5 bg-[#f2f2f2]"},Xe={class:"relative my-2 text-center"},et={class:"mx-auto inline-flex items-center gap-2 text-xs text-[#9CA3AF]"},tt={key:0,class:"flex justify-center items-center h-full"},st={key:1,class:"space-y-4"},ot={key:0,class:"text-pretty"},at={key:1,class:"mt-2"},rt=["src","onClick"],nt={key:2,class:"flex items-center justify-center h-full"},lt={class:"border-t border-[#E5E7EB] bg-[#f2f2f2] px-4 py-3"},it={class:"relative flex items-center rounded-full border border-[#E5E7EB] bg-white pl-10 pr-14"},dt=["disabled"],ct={key:0,class:"mt-3 flex items-center justify-between bg-white p-2 rounded-lg"},ut={class:"flex items-center"},mt=["src"],vt=["src"],S="https://via.placeholder.com/150",gt={__name:"Messages",setup(pt){const H=le(),K=ne(),k=v(!0),F=v(!1),y=v(!1),p=v([]),d=v(null),x=v([]),f=v(""),m=v(null),R=v(null),w=v(null),b=v(!1),E=v(null),h=v(null),j=v(!1),I=v(null),T=()=>{b.value=window.innerWidth<768},G=async()=>{var r;k.value=!0;try{const t=await B.post("/listConversationsProvider");if(t.data&&t.data.success){p.value=t.data.data||[];const{bookingId:s,customerId:o,openChat:n}=K.query;if(s&&o&&n==="true"){const a=p.value.find(c=>c.booking_id==s&&c.customer_id==o);a?C(a):await W(s,o)}else p.value.length>0&&!d.value&&C(p.value[0])}else console.error("Failed to load conversations:",((r=t.data)==null?void 0:r.message)||"Unknown error"),p.value=[]}catch(t){console.error("Error loading conversations:",t),p.value=[]}finally{k.value=!1}},W=async(r,t)=>{var s,o,n;try{const a=await B.post("/providerGetConversationMessages",{receiver_id:t,booking_id:r});if(a.data&&a.data.success){const c=a.data.data,M={id:Date.now(),customer_id:t,provider_id:JSON.parse(localStorage.getItem("userData")||"{}").id,booking_id:r,customer_first_name:((s=c.booking)==null?void 0:s.customer_name)||"Customer",customer_last_name:"",customer_img:((o=c.booking)==null?void 0:o.customer_img)||S,last_message:"No messages yet",updated_at:new Date().toISOString(),unread_count:0,online:!0,services:((n=c.booking)==null?void 0:n.services)||[]};p.value.unshift(M),C(M),x.value=c.messages||[],c.booking&&(m.value={id:c.booking.id,date:c.booking.date,time:c.booking.time,total_price:c.booking.total_price,booking_status:c.booking.booking_status,services:c.booking.services||[]}),D(()=>{A()})}}catch(a){console.error("Error creating/opening conversation:",a)}},Z=()=>{d.value=null},C=async r=>{var t;d.value=r,F.value=!0,x.value=[];try{const s=await B.post("/providerGetConversationMessages",{receiver_id:r.customer_id,booking_id:r.booking_id});if(s.data&&s.data.success){const o=s.data.data;x.value=o.messages||[],o.booking&&(m.value={id:o.booking.id,date:o.booking.date,time:o.booking.time,total_price:o.booking.total_price,booking_status:o.booking.booking_status,services:o.booking.services||[]},R.value={name:o.booking.business_name,email:r.provider_email,phone:r.provider_mobile,opening_hours:"Mon-Fri: 9AM-6PM, Sat: 9AM-1PM"})}else console.error("Failed to load messages:",((t=s.data)==null?void 0:t.message)||"Unknown error")}catch(s){console.error("Error loading messages:",s)}finally{F.value=!1,D(()=>{A()})}},q=()=>{E.value.click()},J=r=>{const t=r.target.files[0];if(!t)return;if(!t.type.startsWith("image/")){alert("Please select an image file");return}if(t.size>2*1024*1024){alert("Image size must be less than 2MB");return}const s=new FileReader;s.onload=o=>{h.value=o.target.result},s.readAsDataURL(t)},V=()=>{h.value=null,E.value&&(E.value.value="")},Y=r=>{I.value=r,j.value=!0},U=()=>{j.value=!1,I.value=null},N=async()=>{var r,t,s;if(!(!f.value.trim()&&!h.value||!d.value||y.value)){y.value=!0;try{const o=new FormData;if(o.append("receiver_id",d.value.customer_id),o.append("booking_id",d.value.booking_id),f.value.trim()&&o.append("message",f.value),h.value){const c=await(await fetch(h.value)).blob(),M=new File([c],"image.jpg",{type:"image/jpeg"});o.append("attachment",M)}const n=await B.post("/providerSendMessage",o,{headers:{"Content-Type":"multipart/form-data"}});if(n.data&&n.data.success){const a=n.data.data;x.value.push({id:a.id,sender_id:a.sender_id,receiver_id:a.receiver_id,booking_id:a.booking_id,message:a.message,attachment:a.attachment,sender_type:a.sender_type,receiver_type:a.receiver_type,created_at:a.created_at,updated_at:a.updated_at}),d.value.last_message=f.value||"Image sent",d.value.updated_at=new Date().toISOString(),f.value="",V(),D(()=>{A()})}else{console.error("Failed to send message:",((r=n.data)==null?void 0:r.message)||"Unknown error");let a=((t=n.data)==null?void 0:t.message)||"Failed to send message";(s=n.data)!=null&&s.errors&&Array.isArray(n.data.errors)&&n.data.errors.length>0&&(a=n.data.errors[0]),P({type:"error",title:"Error",message:a,confirmButtonText:"OK"})}}catch(o){console.error("Error sending message:",o);let n="Failed to send message";if(o.response&&o.response.data){const a=o.response.data;n=a.message||n,a.errors&&Array.isArray(a.errors)&&a.errors.length>0&&(n=a.errors[0])}P({type:"error",title:"Error",message:n,confirmButtonText:"OK"})}finally{y.value=!1}}},A=()=>{w.value&&(w.value.scrollTop=w.value.scrollHeight)},z=r=>{if(!r)return"";const t=new Date(r),o=Math.floor((new Date-t)/1e3);if(o<60)return"Just now";const n=Math.floor(o/60);if(n<60)return`${n} ${n===1?"minute":"minutes"} ago`;const a=Math.floor(n/60);if(a<24)return`${a} ${a===1?"hour":"hours"} ago`;const c=Math.floor(a/24);return c<7?`${c} ${c===1?"day":"days"} ago`:t.toLocaleDateString([],{month:"short",day:"numeric"})},Q=r=>new Date(r).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),X=()=>new Date().toLocaleDateString([],{day:"numeric",month:"long"}),ee=r=>r?r.charAt(0).toUpperCase()+r.slice(1):"Unknown",te=()=>{H.push("/provider/bookings")};return oe(()=>{T(),window.addEventListener("resize",T),G()}),(r,t)=>(l(),ae(me,null,{default:re(()=>[e("div",ve,[t[20]||(t[20]=e("div",{class:"px-6 pt-6"},[e("nav",{class:"text-sm text-[#6B7280]"},[e("span",{class:"hover:underline cursor-default"},"Provider Account"),e("span",{class:"mx-2"},"›"),e("span",{class:"text-[#111827] font-medium"},"Messages")]),e("h1",{class:"mt-4 text-3xl font-bold tracking-tight"},"Messages")],-1)),e("div",ge,[!k.value&&p.value.length===0?(l(),i("div",pe,[t[2]||(t[2]=e("div",{class:"flex justify-center mb-6"},[e("svg",{width:"64",height:"64",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("path",{d:"M20 13V6C20 5.46957 19.7893 4.96086 19.4142 4.58579C19.0391 4.21071 18.5304 4 18 4H6C5.46957 4 4.96086 4.21071 4.58579 4.58579C4.21071 4.96086 4 5.46957 4 6V13",stroke:"#E5E7EB","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M20 13L16 9L12 13L8 9L4 13",stroke:"#E5E7EB","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M4 13V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C19.0391 21.7893 20 20.5304 20 20V13",stroke:"#E5E7EB","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})])],-1)),t[3]||(t[3]=e("h3",{class:"text-lg font-medium text-gray-900 mb-2"},"You don't have any messages yet.",-1)),t[4]||(t[4]=e("p",{class:"text-gray-500 mb-8"},"When customers send you messages, they will appear here.",-1)),e("button",{onClick:te,class:"px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-medium"}," View Bookings ")])):g("",!0),k.value?(l(),i("div",fe,[...t[5]||(t[5]=[e("div",{class:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-500"},null,-1)])])):g("",!0),!k.value&&p.value.length>0?(l(),i("div",he,[e("aside",{class:_(["w-full md:w-80 lg:w-80 xl:w-80 border-r border-[#E5E7EB]",{"hidden md:block":d.value&&b.value,block:!d.value||!b.value}])},[e("header",_e,[e("h2",xe,"All messages ("+u(p.value.length)+")",1)]),e("ul",be,[(l(!0),i($,null,O(p.value,s=>(l(),i("li",{key:s.id,class:_(["p-3 hover:bg-[#F9FAFB] cursor-pointer transition-colors",d.value&&d.value.id===s.id?"bg-[#FFF7F8]":""]),onClick:o=>C(s)},[e("div",ye,[e("div",we,[e("img",{src:s.customer_img||S,alt:s.customer_first_name||"Customer",class:"h-12 w-12 rounded-lg object-cover"},null,8,Ee),e("span",{class:_(["absolute -bottom-0.5 -right-0.5 h-3 w-3 rounded-full ring-2 ring-white",s.online?"bg-[#22C55E]":"bg-[#9CA3AF]"]),"aria-hidden":"true"},null,2)]),e("div",Ce,[e("div",Me,[e("p",Be,u(s.customer_first_name)+" "+u(s.customer_last_name),1),e("span",Fe,u(z(s.updated_at)),1)]),e("div",je,[t[6]||(t[6]=e("span",{class:"uppercase tracking-wide text-[#182224BF] font-bold",style:{width:"50%"}},"Hire for",-1)),s.services&&s.services.length>0?(l(),i("span",Ie,u(s.services[0].cat_name||s.services[0].additional_service_name),1)):g("",!0)]),e("div",Ae,[e("p",De," ME: "+u(s.last_message||"No messages yet"),1),s.unread_count>0?(l(),i("span",Le,u(s.unread_count),1)):g("",!0)])])])],10,ke))),128))])],2),e("section",{class:_(["flex-1 flex flex-col min-h-[640px]",{"hidden md:flex":!d.value&&b.value,flex:d.value||!b.value}])},[d.value&&b.value?(l(),i("div",Se,[e("button",{onClick:Z,class:"flex items-center text-sm font-medium text-[#111827]"},[...t[7]||(t[7]=[e("svg",{class:"mr-2 h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1),L(" Back to conversations ",-1)])])])):g("",!0),d.value?(l(),i("div",Ve,[e("header",Ue,[e("div",Ne,[e("img",{src:d.value.customer_img||S,alt:d.value.customer_first_name||"Customer",class:"h-10 w-10 rounded-md object-cover border border-[#E5E7EB]"},null,8,ze),e("div",null,[e("p",$e,u(d.value.customer_first_name)+" "+u(d.value.customer_last_name),1),e("p",Oe,u(z(d.value.updated_at)),1)])])]),m.value?(l(),i("div",Pe,[e("div",He,[e("div",null,[e("p",Ke,[m.value.services&&m.value.services.length>0?(l(),i("span",Re,[m.value.services.length===1?(l(),i("span",Ge,u(m.value.services[0].cat_name||m.value.services[0].sub_cat_name||m.value.services[0].additional_service_name),1)):(l(),i("span",We,[L(u(m.value.services[0].cat_name||m.value.services[0].sub_cat_name||m.value.services[0].additional_service_name)+" ",1),e("span",null,", +"+u(m.value.services.length-1)+" more",1)]))])):g("",!0),t[9]||(t[9]=e("span",{class:"ml-2 text-[#6B7280]"},"2 hours",-1))])])]),e("div",Ze,[e("div",qe,[e("p",Je,"£"+u(m.value.total_price),1),e("p",Ye,u(ee(m.value.booking_status)),1)])])])):g("",!0),t[19]||(t[19]=e("div",{class:"border-b border-[#E5E7EB] bg-[#f2f2f2] px-5 py-3"},[e("div",{class:"flex items-start gap-3 text-sm text-[#6B7280]"},[e("svg",{width:"18",height:"21",viewBox:"0 0 18 21",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("path",{d:"M8.86364 0L0 4.3283V4.75C0 9.43027 0.103974 12.1837 1.16966 14.3514C2.23534 16.5191 5.11742 18.8318 8.57955 20.8358L8.86364 21L9.14773 20.8358C12.6098 18.8318 15.4919 16.5191 16.5576 14.3514C17.6233 12.1837 17.7273 9.43027 17.7273 4.75V4.3283L8.86364 0ZM12.6611 6.5411C13.6975 6.51156 14.23 7.76928 13.4868 8.49201L8.2768 13.702C7.88627 14.0925 7.25311 14.0925 6.86258 13.702L4.26713 11.1065C3.15123 10.0361 4.80357 8.38374 5.87402 9.49965L7.56969 11.1953L11.8799 6.88512C12.0857 6.67328 12.3659 6.54989 12.6611 6.5411Z",fill:"#34A356"})]),e("p",null," For your protection, keep communication and payments within Donderstorm. Content may be moderated if it violates our Community Guidelines. ")])],-1)),e("div",Qe,[e("div",Xe,[e("span",et,[t[10]||(t[10]=e("span",{class:"inline-block h-px w-12 bg-[#E5E7EB]"},null,-1)),L(" "+u(X())+" ",1),t[11]||(t[11]=e("span",{class:"inline-block h-px w-12 bg-[#E5E7EB]"},null,-1))])]),t[12]||(t[12]=e("p",{class:"text-center text-xs text-[#9CA3AF]"},"You and customer are connected",-1))]),e("div",{ref_key:"scrollEl",ref:w,class:"flex-1 overflow-y-auto px-5 py-4 space-y-4 bg-[#f2f2f2]"},[F.value?(l(),i("div",tt,[...t[13]||(t[13]=[e("div",{class:"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-red-500"},null,-1)])])):x.value.length>0?(l(),i("div",st,[(l(!0),i($,null,O(x.value,s=>(l(),i("div",{key:s.id,class:_(["flex",s.sender_type==="provider"?"justify-end":"justify-start"])},[e("div",{class:_(["relative max-w-[70%] rounded-lg px-4 py-2 text-sm shadow-sm",s.sender_type==="provider"?"bg-[#1F2937] text-white bubble-out":"bg-white text-[#111827] border border-[#E5E7EB] bubble-in"])},[s.message?(l(),i("p",ot,u(s.message),1)):g("",!0),s.attachment?(l(),i("div",at,[e("img",{src:s.attachment,alt:"Attachment",class:"max-w-full rounded-lg cursor-pointer",onClick:o=>Y(s.attachment)},null,8,rt)])):g("",!0),e("div",{class:_(["text-xs mt-1",s.sender_type==="provider"?"text-gray-300":"text-[#6B7280]"])},u(Q(s.created_at)),3)],2)],2))),128))])):(l(),i("div",nt,[...t[14]||(t[14]=[e("p",{class:"text-gray-500"},"No messages yet. Start the conversation!",-1)])]))],512),e("div",lt,[e("div",it,[e("button",{onClick:q,class:"absolute left-3 text-[#6B7280]","aria-label":"Upload Image"},[...t[15]||(t[15]=[e("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[e("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2","stroke-width":"1.5"}),e("circle",{cx:"8.5",cy:"8.5",r:"1.5","stroke-width":"1.5"}),e("polyline",{points:"21 15 16 10 5 21","stroke-width":"1.5"})],-1)])]),e("input",{ref_key:"fileInput",ref:E,onChange:J,type:"file",class:"hidden",accept:"image/*"},null,544),ie(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>f.value=s),type:"text",placeholder:"Type a message...",class:"w-full rounded-full bg-transparent py-2.5 text-sm outline-none placeholder:text-[#9CA3AF]",onKeyup:de(N,["enter"])},null,544),[[ce,f.value]]),e("button",{class:"absolute right-2 grid h-9 w-9 place-items-center rounded-full bg-[#ff5a70] text-white shadow hover:opacity-90","aria-label":"Send",onClick:N,disabled:!f.value.trim()&&!h.value||y.value},[...t[16]||(t[16]=[e("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[e("path",{d:"M22 2L11 13","stroke-width":"1.6","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M22 2l-7 20-4-9-9-4 20-7Z","stroke-width":"1.6","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],8,dt)]),h.value?(l(),i("div",ct,[e("div",ut,[e("img",{src:h.value,alt:"Selected image",class:"w-10 h-10 object-cover rounded mr-2"},null,8,mt),t[17]||(t[17]=e("span",{class:"text-sm text-gray-700"},"Image selected",-1))]),e("button",{onClick:V,class:"text-gray-500 hover:text-gray-700"},[...t[18]||(t[18]=[e("svg",{class:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])):g("",!0)])])):(l(),i("div",Te,[...t[8]||(t[8]=[e("div",{class:"text-center"},[e("svg",{class:"mx-auto h-12 w-12 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"})]),e("h3",{class:"mt-2 text-sm font-medium text-gray-900"},"No conversation selected"),e("p",{class:"mt-1 text-sm text-gray-500"},"Select a conversation to start chatting")],-1)])]))],2)])):g("",!0)])]),j.value?(l(),i("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50",onClick:U},[e("div",{class:"relative max-w-4xl max-h-[90vh] overflow-auto",onClick:t[1]||(t[1]=ue(()=>{},["stop"]))},[e("img",{src:I.value,alt:"Full size image",class:"max-w-full max-h-full object-contain"},null,8,vt),e("button",{onClick:U,class:"absolute top-4 right-4 bg-white rounded-full p-2 shadow-lg"},[...t[21]||(t[21]=[e("svg",{class:"w-6 h-6 text-gray-800",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])])):g("",!0)]),_:1}))}},bt=se(gt,[["__scopeId","data-v-1505bcd9"]]);export{bt as default};
