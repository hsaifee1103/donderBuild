import{l as H,D as X,d as L,r as _,b as Z,k as M,f as d,o as u,g as p,j as Q,a as e,t as c,h as W,n as g,i as v,v as w,A as ee,H as P,E as te,R as ae,F as ie,I as $}from"./app-CeYD0-mp.js";const se={key:0,class:"page"},re={class:"container"},oe={class:"lead"},le={class:"title text-start"},ne={class:"field"},de={class:"with-icon"},ue=["disabled"],ce={key:0,class:"spinner"},me={key:1,width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",class:"text-gray-500"},fe={key:0,class:"error-text"},pe={class:"field"},ge={key:0,class:"error-text"},ve={class:"field"},ye={key:0,class:"error-text"},he={class:"field"},be={class:"with-icon"},ke={key:0,class:"error-text"},_e={class:"field"},we={class:"with-icon"},Ne={key:0,class:"error-text"},Se={class:"field"},Te={class:"with-icon"},xe=["max"],Me={key:0,class:"error-text"},Oe={key:0,class:"mb-4 p-3 bg-red-50 text-red-700 rounded-lg"},Ve={class:"flex items-start"},De={class:"text-sm"},Ce={class:"form-actions"},ze=["disabled"],Re={__name:"AddVehicleForm",props:{isVisible:{type:Boolean,default:!1},errorMessage:{type:String,default:null},formData:{type:Object,default:()=>({})}},emits:["close","submit"],setup(O,{emit:Y}){var z,R,F,A,q,E,j,B;const l=O,V=Y,N=new Date().getFullYear(),a=X({registrationNumber:((z=l.formData)==null?void 0:z.registrationNumber)||"",postcode:((R=l.formData)==null?void 0:R.postcode)||"Not required",engineSize:((F=l.formData)==null?void 0:F.engineSize)||"",transmission:((A=l.formData)==null?void 0:A.transmission)||"",fuelType:((q=l.formData)==null?void 0:q.fuelType)||"",yearOfRegistration:((E=l.formData)==null?void 0:E.yearOfRegistration)||"",carModel:((j=l.formData)==null?void 0:j.carModel)||"",car_id:((B=l.formData)==null?void 0:B.car_id)||null}),S=L(()=>l.formData.car_id),T=_(""),b=_(!1);Z(async()=>{try{const i=await M.get("/dvla-key");i.data&&i.data.success&&(T.value=i.data.data.dvla_key)}catch(i){console.error("Failed to fetch DVLA key",i)}});const D=async()=>{if(!a.registrationNumber){s.value={registrationNumber:"Please enter a registration number"};return}if(!T.value){console.error("DVLA Key not available"),s.value={general:"Service unavailable. Please enter details manually."};return}b.value=!0,s.value={};try{const i=await fetch("https://driver-vehicle-licensing.api.gov.uk/vehicle-enquiry/v1/vehicles",{method:"POST",headers:{"x-api-key":T.value,"Content-Type":"application/json"},body:JSON.stringify({registrationNumber:a.registrationNumber})});if(i.ok){const t=await i.json();a.carModel=t.make||"",a.yearOfRegistration=t.yearOfManufacture||"",a.engineSize=t.engineCapacity?String(t.engineCapacity):"";const r=(t.fuelType||"").toLowerCase();r.includes("petrol")?a.fuelType="petrol":r.includes("diesel")?a.fuelType="diesel":a.fuelType="",$({type:"success",title:"Vehicle Found",message:"Vehicle details have been populated.",confirmButtonText:"OK"})}else{const t=await i.json();i.status===404?s.value={registrationNumber:"Vehicle not found. Please check registration."}:s.value={general:"Failed to lookup vehicle. Please enter manually."}}}catch(i){console.error("DVLA Search Error",i),s.value={general:"Connection error. Please try again."}}finally{b.value=!1}},I=async()=>{var i,t;if(!(!G()||y.value)){y.value=!0,s.value={};try{const r=K();if(!r)throw new Error("User not authenticated");const h={postcode:a.postcode,car_make:a.carModel,car_model:a.registrationNumber,engine_size:a.engineSize,fuelType:a.fuelType,yearOfManufacture:a.yearOfRegistration,user_id:r,transmission:a.transmission};let o;if(S.value?(h.car_id=a.car_id,o=await M.post("/update-car-details",h)):o=await M.post("/car_details",h),o.data&&o.data.success)V("submit",{...a}),C(),$({type:"success",title:S.value?"Vehicle Updated Successfully":"Vehicle Added Successfully",message:o.data.message||(S.value?"Your vehicle details have been updated.":"Your vehicle has been added to your profile."),confirmButtonText:"Great!"});else if(o.data&&o.data.errors){const m=o.data.errors,n={};m.forEach(f=>{const x=f.match(/The (.+?) field/);if(x){const k=x[1],U={postcode:"postcode",car_make:"carModel",car_model:"registrationNumber",engine_size:"engineSize",fuelType:"fuelType",yearOfManufacture:"yearOfRegistration",transmission:"transmission"}[k];U?n[U]=f:n.general=n.general?`${n.general}; ${f}`:f}else n.general=n.general?`${n.general}; ${f}`:f}),s.value=n}else s.value.general=((i=o.data)==null?void 0:i.message)||"Failed to submit vehicle details. Please try again."}catch(r){if(console.error("Error submitting vehicle form:",r),r.response)if(r.response.status===422){const h=r.response.data.errors||[],o={};h.forEach(m=>{const n=m.match(/The (.+?) field/);if(n){const f=n[1],k={postcode:"postcode",car_make:"carModel",car_model:"registrationNumber",engine_size:"engineSize",fuelType:"fuelType",yearOfManufacture:"yearOfRegistration",transmission:"transmission"}[f];k?o[k]=m:o.general=o.general?`${o.general}; ${m}`:m}else o.general=o.general?`${o.general}; ${m}`:m}),s.value=o}else s.value.general=((t=r.response.data)==null?void 0:t.message)||"Server error occurred";else r.request?s.value.general="Network error. Please check your connection.":s.value.general=r.message||"An unexpected error occurred"}finally{y.value=!1}}},y=_(!1),s=_({}),K=()=>{const i=localStorage.getItem("userData");return i?JSON.parse(i).id:null},J=L(()=>!!a.registrationNumber&&!!a.engineSize&&!!a.transmission&&!!a.fuelType&&!!a.yearOfRegistration&&!!a.carModel),G=()=>{const i={};return a.registrationNumber||(i.registrationNumber="Registration number is required"),a.engineSize||(i.engineSize="Engine size is required"),a.transmission?["manual","automatic"].includes(a.transmission)||(i.transmission="Transmission must be manual or automatic"):i.transmission="Transmission is required",a.fuelType?["petrol","diesel"].includes(a.fuelType)||(i.fuelType="Fuel type must be petrol or diesel"):i.fuelType="Fuel type is required",a.yearOfRegistration?(a.yearOfRegistration<1900||a.yearOfRegistration>N)&&(i.yearOfRegistration=`Year must be between 1900 and ${N}`):i.yearOfRegistration="Year of registration is required",a.carModel||(i.carModel="Car model is required"),s.value=i,Object.keys(i).length===0},C=()=>{V("close"),Object.keys(a).forEach(i=>{a[i]=""}),s.value={}};return(i,t)=>(u(),d(ie,null,[O.isVisible?(u(),d("div",se,[e("div",re,[e("section",oe,[e("h1",le,c(l.formData.car_id?"Edit":"Add")+" Your Car Details",1)]),e("form",{class:"form",onSubmit:W(I,["prevent"])},[e("label",ne,[t[7]||(t[7]=e("span",null,[g("Registration Number "),e("b",{"aria-hidden":"true"},"*")],-1)),e("div",de,[v(e("input",{id:"registrationNumber","onUpdate:modelValue":t[0]||(t[0]=r=>a.registrationNumber=r),type:"text",placeholder:"e.g. AB12 CDE",required:"",onKeyup:ee(D,["enter"])},null,544),[[w,a.registrationNumber,void 0,{trim:!0}]]),e("button",{type:"button",onClick:D,class:"trailing-btn",disabled:b.value,title:"Search Vehicle Details"},[b.value?(u(),d("div",ce)):(u(),d("svg",me,[...t[6]||(t[6]=[e("path",{d:"M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)])]))],8,ue)]),s.value.registrationNumber?(u(),d("small",fe,c(s.value.registrationNumber),1)):p("",!0)]),e("label",pe,[t[8]||(t[8]=e("span",null,[g("Car Make "),e("b",{"aria-hidden":"true"},"*")],-1)),v(e("input",{id:"carModel","onUpdate:modelValue":t[1]||(t[1]=r=>a.carModel=r),type:"text",placeholder:"e.g. Fiesta, Corolla, X5",required:""},null,512),[[w,a.carModel,void 0,{trim:!0}]]),s.value.carModel?(u(),d("small",ge,c(s.value.carModel),1)):p("",!0)]),e("label",ve,[t[9]||(t[9]=e("span",null,[g("Engine Size "),e("b",{"aria-hidden":"true"},"*")],-1)),v(e("input",{id:"engineSize","onUpdate:modelValue":t[2]||(t[2]=r=>a.engineSize=r),type:"text",placeholder:"e.g. 1.6L",required:""},null,512),[[w,a.engineSize,void 0,{trim:!0}]]),s.value.engineSize?(u(),d("small",ye,c(s.value.engineSize),1)):p("",!0)]),e("label",he,[t[12]||(t[12]=e("span",null,[g("Transmission "),e("b",{"aria-hidden":"true"},"*")],-1)),e("div",be,[v(e("select",{id:"transmission","onUpdate:modelValue":t[3]||(t[3]=r=>a.transmission=r),required:""},[...t[10]||(t[10]=[e("option",{value:""},"Select transmission",-1),e("option",{value:"manual"},"Manual",-1),e("option",{value:"automatic"},"Automatic",-1)])],512),[[P,a.transmission]]),t[11]||(t[11]=e("svg",{class:"trailing",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none","aria-hidden":"true"},[e("path",{d:"M6 9l6 6 6-6",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1))]),s.value.transmission?(u(),d("small",ke,c(s.value.transmission),1)):p("",!0)]),e("label",_e,[t[15]||(t[15]=e("span",null,[g("Fuel Type "),e("b",{"aria-hidden":"true"},"*")],-1)),e("div",we,[v(e("select",{id:"fuelType","onUpdate:modelValue":t[4]||(t[4]=r=>a.fuelType=r),required:""},[...t[13]||(t[13]=[e("option",{value:""},"Select fuel type",-1),e("option",{value:"petrol"},"Petrol",-1),e("option",{value:"diesel"},"Diesel",-1)])],512),[[P,a.fuelType]]),t[14]||(t[14]=e("svg",{class:"trailing",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none","aria-hidden":"true"},[e("path",{d:"M6 9l6 6 6-6",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1))]),s.value.fuelType?(u(),d("small",Ne,c(s.value.fuelType),1)):p("",!0)]),e("label",Se,[t[17]||(t[17]=e("span",null,[g("Year of Registration "),e("b",{"aria-hidden":"true"},"*")],-1)),e("div",Te,[v(e("input",{id:"yearOfRegistration","onUpdate:modelValue":t[5]||(t[5]=r=>a.yearOfRegistration=r),type:"number",min:"1900",max:te(N),placeholder:"e.g. 2020",required:""},null,8,xe),[[w,a.yearOfRegistration]]),t[16]||(t[16]=e("svg",{class:"trailing",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none","aria-hidden":"true"},[e("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",stroke:"currentColor","stroke-width":"2"}),e("path",{d:"M16 2v4M8 2v4M3 10h18",stroke:"currentColor","stroke-width":"2"})],-1))]),s.value.yearOfRegistration?(u(),d("small",Me,c(s.value.yearOfRegistration),1)):p("",!0)]),s.value.general?(u(),d("div",Oe,[e("div",Ve,[t[19]||(t[19]=e("svg",{class:"h-5 w-5 text-red-500 mr-2 mt-0.5",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z","clip-rule":"evenodd"})],-1)),e("div",null,[t[18]||(t[18]=e("p",{class:"font-medium"},"Error",-1)),e("p",De,c(s.value.general),1)])])])):p("",!0),e("div",Ce,[e("button",{type:"button",onClick:C,class:"cancel-btn"}," Cancel "),e("button",{type:"submit",class:"submit-btn",disabled:!J.value||y.value},c(y.value?l.formData.car_id?"Updating Vehicle...":"Adding Vehicle...":l.formData.car_id?"Update Vehicle":"Add Vehicle"),9,ze)])],32)])])):p("",!0),Q(ae)],64))}},qe=H(Re,[["__scopeId","data-v-869a398e"]]);export{qe as A};
